<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>测试 | 潇</title>
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../assets/css/global.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.4/dist/umd/supabase.min.js"></script>
  <script src="../../assets/js/supabase-config.js"></script>
  <script src="../../assets/js/supabase-util.js"></script>
  <script src="../../assets/js/admin.js"></script>
</head>
<body class="min-h-screen">
  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
    <div class="frosted-glass p-6 rounded-xl">
      <h1 class="text-2xl font-bold mb-4">端到端通信测试</h1>
      <div class="space-y-3 text-sm text-gray-700">
        <button id="run-e2e" class="btn-primary">运行E2E测试</button>
        <button id="run-bulk" class="btn-primary">大数据量测试(50条)</button>
        <div id="result" class="mt-3"></div>
      </div>
    </div>
  </main>
  <script>
    function logLine(msg){ const r=document.getElementById('result'); const div=document.createElement('div'); div.textContent=msg; r.appendChild(div); }
    document.getElementById('run-e2e').addEventListener('click', async ()=>{
      const c = await Admin.getClient(); if(!c){ logLine('客户端初始化失败'); return; }
      const start=performance.now();
      try{
        const payload={ name:'TestUser', email:'test@example.com', subject:'E2E', message:'Hello '+Date.now() };
        await Admin.log('request','insert contact_messages',null,null,null,payload);
        const ins = await c.from('contact_messages').insert(payload).select();
        const latency=Math.round(performance.now()-start);
        await Admin.log('response','insert contact_messages', ins.error?500:200, latency, ins.error?.message, ins.data||{});
        logLine('插入结果：'+(ins.error?ins.error.message:'成功'));
        const sel = await c.from('contact_messages').select('*').eq('id', ins.data?.[0]?.id).single();
        logLine('查询结果：'+(sel.error?sel.error.message:'成功'));
      }catch(e){ logLine('E2E错误：'+e.message); }
    });
    document.getElementById('run-bulk').addEventListener('click', async ()=>{
      const c = await Admin.getClient(); if(!c){ logLine('客户端初始化失败'); return; }
      const start = performance.now();
      const items = Array.from({length:50}).map((_,i)=>({ name:'Bulk'+i, email:'bulk@example.com', subject:'Bulk', message:'m'+i }));
      const res = await c.from('contact_messages').insert(items);
      const latency=Math.round(performance.now()-start);
      await Admin.log('response','bulk insert', res.error?500:200, latency, res.error?.message, { count: items.length });
      logLine('批量插入延迟：'+latency+'ms，结果：'+(res.error?res.error.message:'成功'));
    });
  </script>
</body>
</html>
