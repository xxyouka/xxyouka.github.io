<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="留言管理页面，支持登录查看、搜索、分页、导出和实时刷新">
  <meta name="keywords" content="留言, 后台, 管理, 搜索, 导出, 实时">
  <title>留言列表 | 潇</title>
  <link rel="icon" href="../images/logo.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="../images/logo.ico">
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../assets/css/global.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.4/dist/umd/supabase.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/supabase-util.js"></script>
  <script src="../assets/js/global.js" defer></script>
  <link rel="canonical" href="https://traexxyoukagithubio2zag.vercel.app/web/messages.html">
</head>
<body class="min-h-screen">
  <header class="frosted-glass sticky top-0 z-20 border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
      <div class="flex flex-row items-center justify-between">
        <h1 class="text-2xl font-bold"><i class="fas fa-code mr-2 text-indigo-500"></i><span class="logo-text">潇</span></h1>
        <nav class="hidden sm:flex space-x-4">
          <a href="../index.html" class="tab-link text-lg font-medium py-2 px-4 hover:text-indigo-500">关于我</a>
          <a href="skills.html" class="tab-link text-lg font-medium py-2 px-4 hover:text-indigo-500">核心技能</a>
          <a href="projects.html" class="tab-link text-lg font-medium py-2 px-4 hover:text-indigo-500">学习项目</a>
          <a href="contact.html" class="tab-link text-lg font-medium py-2 px-4 hover:text-indigo-500">联系我</a>
          <a href="messages.html" class="tab-link active-tab text-lg font-medium py-2 px-4">留言列表</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
    <div class="frosted-glass p-6 sm:p-10 rounded-2xl">
      <h2 class="text-2xl font-bold mb-4">留言列表</h2>
      <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">邮箱</label>
          <input id="login-email" type="email" value="1420272691@qq.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">密码（可选）</label>
          <input id="login-password" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="用于密码登录">
        </div>
        <div class="flex gap-2">
          <button id="login-btn" class="btn-primary touch-target"><i class="fas fa-link mr-2"></i>发送登录链接</button>
          <button id="password-login-btn" class="btn-primary touch-target"><i class="fas fa-key mr-2"></i>密码登录</button>
          <button id="signup-btn" class="btn-primary touch-target bg-purple-600"><i class="fas fa-user-plus mr-2"></i>注册/设置密码</button>
          <button id="logout-btn" class="btn-primary bg-gray-200 text-gray-700 touch-target"><i class="fas fa-sign-out-alt mr-2"></i>退出</button>
        </div>
      </div>
      <div id="status" class="text-sm text-gray-600 mb-3" aria-live="polite"></div>
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <input id="search" type="text" class="px-3 py-2 border border-gray-300 rounded-lg" placeholder="搜索姓名/联系方式/主题/留言">
        <input id="start-date" type="date" class="px-3 py-2 border border-gray-300 rounded-lg">
        <input id="end-date" type="date" class="px-3 py-2 border border-gray-300 rounded-lg">
        <button id="refresh" class="btn-primary"><i class="fas fa-sync mr-2"></i>刷新</button>
        <button id="export" class="btn-primary"><i class="fas fa-file-export mr-2"></i>导出CSV</button>
        <div class="ml-auto flex items-center gap-2">
          <span id="user-email" class="text-sm text-gray-600"></span>
          <button id="prev" class="btn-primary bg-gray-200 text-gray-700">上一页</button>
          <span id="page-info" class="text-sm text-gray-600">第 1 页</span>
          <button id="next" class="btn-primary">下一页</button>
        </div>
      </div>
      <div id="list" class="overflow-x-auto">
        <table class="min-w-full text-left text-sm table-sticky">
          <thead>
            <tr>
              <th id="th-time" class="py-2 px-3 cursor-pointer select-none">时间</th>
              <th class="py-2 px-3">姓名</th>
              <th class="py-2 px-3">联系方式</th>
              <th class="py-2 px-3">主题</th>
              <th class="py-2 px-3">留言</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
        <div id="empty" class="text-center text-gray-500 py-6 hidden">暂无数据</div>
      </div>
    </div>
  </main>

  <div id="msg-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl max-w-2xl w-full p-6">
      <h3 id="modal-title" class="text-lg font-semibold mb-3"></h3>
      <div id="modal-body" class="text-gray-700 whitespace-pre-wrap break-words"></div>
      <div class="mt-4 text-right">
        <button id="close-modal" class="btn-primary bg-gray-200 text-gray-700">关闭</button>
      </div>
    </div>
  </div>
  <div id="loading" class="loading"><div class="spinner"></div></div>

  <script>
    const rows = document.getElementById('rows');
    const status = document.getElementById('status');
    const empty = document.getElementById('empty');
    const loading = document.getElementById('loading');
    function setStatus(message, type){
      status.textContent = message;
      status.classList.remove('text-green-600','text-red-600');
      if(type==='success') status.classList.add('text-green-600');
      if(type==='error') status.classList.add('text-red-600');
    }
    let client = null;
    let currentData = [];
    function esc(s){ return String(s||'').replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
    function hi(s, term){ if(!term) return esc(s); const r = new RegExp('('+term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'); return esc(s).replace(r,'<mark>$1</mark>'); }
    function render(items){
      currentData = items || [];
      if(!currentData.length){ rows.innerHTML=''; empty.classList.remove('hidden'); return; } else { empty.classList.add('hidden'); }
      rows.innerHTML = currentData.map(x=>`<tr>
        <td class="py-2 px-3">${new Date(x.created_at).toLocaleString()}</td>
        <td class="py-2 px-3">${hi(x.name,'')}</td>
        <td class="py-2 px-3"><span>${hi(x.email,'')}</span> <button class="ml-2 text-indigo-600 underline text-xs" data-copy="${esc(x.email)}">复制</button></td>
        <td class="py-2 px-3">${hi(x.subject,'')}</td>
        <td class="py-2 px-3 whitespace-pre-wrap break-words"><button class="text-indigo-600 underline text-xs" data-view="${esc(x.id)}">查看</button></td>
      </tr>`).join('');
    }
    const PAGE_SIZE = 20; let page=1; let total=0; let term=''; let sortAsc=false; let searchTimer=null;
    async function load(){
      if(!client) return;
      loading.classList.add('show'); setStatus('正在加载...', 'info');
      try{
        const sd = document.getElementById('start-date').value; const ed = document.getElementById('end-date').value;
        let countQ = client.from('contact_messages').select('*', { count: 'exact', head: true });
        if(term){ countQ = countQ.or(`name.ilike.%${term}%,email.ilike.%${term}%,subject.ilike.%${term}%,message.ilike.%${term}%`); }
        if(sd) countQ = countQ.gte('created_at', new Date(sd).toISOString());
        if(ed) countQ = countQ.lte('created_at', new Date(ed+'T23:59:59').toISOString());
        const countRes = await countQ;
        if(countRes.error){ setStatus(`统计失败：${countRes.error.message}`, 'error'); return; }
        total = countRes.count || 0;
        const start = (page-1)*PAGE_SIZE; const end = start + PAGE_SIZE - 1;
        let q = client.from('contact_messages').select('*').order('created_at', { ascending: sortAsc }).range(start, end);
        if(term){ q = q.or(`name.ilike.%${term}%,email.ilike.%${term}%,subject.ilike.%${term}%,message.ilike.%${term}%`); }
        if(sd) q = q.gte('created_at', new Date(sd).toISOString());
        if(ed) q = q.lte('created_at', new Date(ed+'T23:59:59').toISOString());
        const { data, error } = await q;
        if(error){ setStatus(`未登录或无权限：${error.message}`, 'error'); return; }
        setStatus('加载成功', 'success');
        render(data||[]);
        const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        document.getElementById('page-info').textContent = `第 ${page} / ${pages} 页（总计 ${total} 条）`;
      }catch(e){ setStatus(`加载失败：${e.message}`, 'error'); }
      finally{ loading.classList.remove('show'); }
    }
    (async ()=>{
      client = await SupaUtil.getClient();
      if(client){
        client.auth.onAuthStateChange(async (_event, session)=>{ if(session) load(); });
        try{ client.channel('messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'contact_messages' }, ()=>{ if(page===1 && !term) load(); }).subscribe(); }catch(e){}
        const u = await client.auth.getUser(); if(u && u.data && u.data.user && u.data.user.email){ document.getElementById('user-email').textContent = u.data.user.email; }
        load();
      }
    })();
    document.getElementById('search').addEventListener('input', (e)=>{ const v=e.target.value.trim(); term=v; page=1; if(searchTimer) clearTimeout(searchTimer); searchTimer=setTimeout(load,300); });
    document.getElementById('refresh').addEventListener('click', ()=> load());
    document.getElementById('prev').addEventListener('click', ()=>{ if(page>1){ page--; load(); } });
    document.getElementById('next').addEventListener('click', ()=>{ const pages = Math.max(1, Math.ceil(total / PAGE_SIZE)); if(page<pages){ page++; load(); } });
    document.getElementById('th-time').addEventListener('click', ()=>{ sortAsc = !sortAsc; page=1; load(); });
    rows.addEventListener('click', (e)=>{
      const t = e.target;
      if(t && t.getAttribute('data-copy')){ navigator.clipboard.writeText(t.getAttribute('data-copy')); setStatus('已复制联系方式', 'success'); }
      if(t && t.getAttribute('data-view')){
        const id = t.getAttribute('data-view'); const item = currentData.find(x=>String(x.id)===String(id));
        if(item){
          document.getElementById('modal-title').textContent = `${item.name||''} · ${item.subject||''}`;
          document.getElementById('modal-body').textContent = item.message||'';
          const modal = document.getElementById('msg-modal'); modal.classList.remove('hidden'); modal.classList.add('flex');
        }
      }
    });
    document.getElementById('close-modal').addEventListener('click', ()=>{ const modal = document.getElementById('msg-modal'); modal.classList.add('hidden'); modal.classList.remove('flex'); });
    document.getElementById('export').addEventListener('click', async ()=>{
      if(!client) return;
      let q = client.from('contact_messages').select('*').order('created_at', { ascending: sortAsc }).range(0, 999);
      if(term){ q = q.or(`name.ilike.%${term}%,email.ilike.%${term}%,subject.ilike.%${term}%,message.ilike.%${term}%`); }
      const sd = document.getElementById('start-date').value; const ed = document.getElementById('end-date').value;
      if(sd) q = q.gte('created_at', new Date(sd).toISOString());
      if(ed) q = q.lte('created_at', new Date(ed+'T23:59:59').toISOString());
      const { data, error } = await q;
      if(error){ setStatus(`导出失败：${error.message}`, 'error'); return; }
      const out = (data||[]).map(x=>[
        new Date(x.created_at).toLocaleString(),
        String(x.name||'').replace(/\n/g,' '),
        String(x.email||'').replace(/\n/g,' '),
        String(x.subject||'').replace(/\n/g,' '),
        String(x.message||'').replace(/\n/g,' ')
      ]);
      const csv = ['时间,姓名,联系方式,主题,留言'].concat(out.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'messages.csv'; a.click(); URL.revokeObjectURL(url);
      setStatus('已导出CSV', 'success');
    });
    document.getElementById('login-btn').addEventListener('click', async (e)=>{ if(!client){ client = await SupaUtil.getClient(); if(!client) return; } e.target.disabled=true; setStatus('正在发送登录链接...', 'info'); try{ const email = document.getElementById('login-email').value; const { error } = await client.auth.signInWithOtp({ email, options:{ shouldCreateUser: true, emailRedirectTo: window.location.href } }); setStatus(error? `登录链接发送失败：${error.message}` : '已发送登录链接，请检查邮箱并在本页面完成登录', error? 'error':'success'); }catch(err){ setStatus(`操作失败：${err.message}`, 'error'); } finally{ e.target.disabled=false; } });
    document.getElementById('password-login-btn').addEventListener('click', async (e)=>{ if(!client){ client = await SupaUtil.getClient(); if(!client) return; } e.target.disabled=true; setStatus('正在登录...', 'info'); try{ const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const { error } = await client.auth.signInWithPassword({ email, password }); setStatus(error? `密码登录失败：${error.message}` : '登录成功', error? 'error':'success'); if(!error) load(); }catch(err){ setStatus(`操作失败：${err.message}`, 'error'); } finally{ e.target.disabled=false; } });
    document.getElementById('signup-btn').addEventListener('click', async (e)=>{ if(!client){ client = await SupaUtil.getClient(); if(!client) return; } e.target.disabled=true; setStatus('正在注册...', 'info'); try{ const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const { error } = await client.auth.signUp({ email, password }); setStatus(error? `注册失败：${error.message}` : '注册成功，请使用密码登录或邮箱链接登录', error? 'error':'success'); }catch(err){ setStatus(`操作失败：${err.message}`, 'error'); } finally{ e.target.disabled=false; } });
    document.getElementById('logout-btn').addEventListener('click', async ()=>{ if(!client) return; await client.auth.signOut(); rows.innerHTML=''; empty.classList.remove('hidden'); setStatus('已退出', 'success'); document.getElementById('user-email').textContent=''; });
  </script>
</body>
</html>
